<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Business of Homelessness — Interactive Sankey (Prototype)</title>
  <style>
    :root{ --bg:#0b0c10; --card:#121419; --muted:#9aa3b2; --green:#4CAF50; --yellow:#FFD700; --red:#FF4C4C; --accent:#76c7ff; }
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#e7edf5}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    h1{font-size:clamp(22px,3vw,32px);margin:0 0 6px}
    p.lead{color:var(--muted);margin:0 0 14px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 16px}
    .pill{background:var(--card);border:1px solid #2a2f3a;border-radius:999px;padding:8px 12px;cursor:pointer;user-select:none}
    .pill[aria-pressed="true"]{outline:2px solid var(--accent)}
    .legend{display:flex;gap:14px;align-items:center;margin:10px 0 0;color:var(--muted);font-size:13px}
    .swatch{width:14px;height:14px;border-radius:4px;display:inline-block;margin-right:6px;border:1px solid #111}
    .card{background:var(--card);border:1px solid #2a2f3a;border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.row{grid-template-columns:2.2fr 1fr}}
    #chart{width:100%;height:560px;min-height:360px}
    .tooltip{position:fixed;pointer-events:none;background:#0f1218;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;font-size:13px;line-height:1.35;max-width:320px;color:#e7edf5;z-index:3}
    .note{font-size:12px;color:var(--muted)}
    a{color:#b8e6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>The Business of Homelessness — Indiana (Prototype)</h1>
    <p class="lead">Toggle between the current system and Housing First. Turn on the Faith Lens and Human Harm overlay to see more than dollars. Data below are <strong>placeholders</strong> until local figures are finalized.</p>

    <div class="controls" role="group" aria-label="View Toggles">
      <button class="pill" id="view-current" aria-pressed="true">Current System</button>
      <button class="pill" id="view-hf" aria-pressed="false">Housing First</button>
      <button class="pill" id="toggle-harm" aria-pressed="true">Human Harm Overlay</button>
      <button class="pill" id="toggle-faith" aria-pressed="false">Faith Lens</button>
      <button class="pill" id="run-test" aria-pressed="false">Run Health Check</button>
      <button class="pill" id="reset" aria-pressed="false">Reset Prototype</button>
    </div>

    <div class="row">
      <div class="card">
        <div id="chart" aria-label="Sankey diagram"></div>
        <div class="legend">
          <span><span class="swatch" style="background:#FF4C4C"></span>High trauma</span>
          <span><span class="swatch" style="background:#FFD700"></span>Moderate trauma</span>
          <span><span class="swatch" style="background:#4CAF50"></span>Low trauma</span>
        </div>
        <p class="note">Sources: local contracts & audits (pending), Indiana Medicaid, national Housing First meta-analyses. Values shown for flow widths are illustrative and will be replaced with citeable figures. Hover nodes for details.</p>
      </div>

      <aside class="card" id="side">
        <h3 style="margin-top:0">Details</h3>
        <div id="details">Hover over a node to see costs, outcomes, and (when enabled) faith reflections.</div>
        <div class="note" id="debug" style="margin-top:10px"></div>
      </aside>
    </div>
  </div>

  <div id="tooltip" class="tooltip" style="opacity:0"></div>

  <!-- Local JS (place these files in ./lib) -->
  <script defer src="./lib/d3.v7.min.js"></script>
  <script defer src="./lib/d3-sankey.min.js"></script>

  <script>
  (function(){
    const TRAUMA_COLORS = { low:'#4CAF50', moderate:'#FFD700', high:'#FF4C4C' };

    const nodesBase = [
      { name: 'Street / Encampment', color:'#9aa3b2', harm:'moderate' },
      { name: 'Police & Jail',       color:'#FF4C4C', harm:'high',    cost:'$60–$85 per day (Indiana jails est.)', outcome:'Short-term incapacitation; record; lost stability', faith:'“Blessed are the merciful…” (Mt 5:7) — mercy requires redesign, not punishment.' },
      { name: 'Courts',              color:'#ff9999', harm:'moderate',cost:'Varies by case & fees', outcome:'Fines, warrants; returns to street' },
      { name: 'ER',                  color:'#FFD700', harm:'moderate',cost:'$30–$150 (Medicaid) • $2,400–$2,600 uninsured avg', outcome:'Crisis-only care; no prevention', faith:'“Bind up the brokenhearted.” — invest upstream.' },
      { name: 'Shelter',             color:'#FFD700', harm:'moderate',cost:'(placeholder) $133/day lodging benchmark', outcome:'Temporary relief; barriers; re-traumatization', faith:'Does a bed without a path home fulfill our call to love?' },
      { name: 'Foster Care',         color:'#ff9999', harm:'high',    cost:'$9,500–$27,700 per child/yr', outcome:'Family separation; long-term harm' },
      { name: 'Housing First',       color:'#4CAF50', harm:'low',     cost:'Rapid Re-Housing ~$8.5k/yr; PSH ~$16.5–$20.1k', outcome:'Stability; reduced system use', faith:'“I was a stranger and you invited me in.” (Mt 25:35)' },
      { name: 'Return to Street',    color:'#9aa3b2', harm:'moderate' },
      { name: 'Ongoing Instability', color:'#FFCC00', harm:'moderate' },
      { name: 'Death',               color:'#111',    harm:'high' },
      { name: 'Stability',           color:'#4CAF50', harm:'low' }
    ];

    const linksCurrentBase = [
      { s:0,t:1,v:20 },{ s:0,t:3,v:15 },{ s:0,t:4,v:25 },{ s:0,t:6,v:5 },
      { s:1,t:2,v:12 },{ s:1,t:8,v:8 },
      { s:3,t:8,v:12 },
      { s:4,t:8,v:20 },{ s:4,t:6,v:5 },
      { s:5,t:8,v:5 },
      { s:6,t:10,v:10 },
      { s:8,t:0,v:10 },{ s:8,t:9,v:2 }
    ];

    const linksHFBase = [
      { s:0,t:6,v:30 },{ s:0,t:4,v:10 },{ s:0,t:3,v:8 },{ s:0,t:1,v:5 },
      { s:6,t:10,v:35 }, { s:4,t:6,v:6 }, { s:3,t:6,v:5 }, { s:1,t:6,v:3 },
      { s:8,t:6,v:8 }
    ];

    const el = document.getElementById('chart');
    const tooltip = document.getElementById('tooltip');
    const details = document.getElementById('details');
    const debug = document.getElementById('debug');

    const state = { view:'current', harm:true, faith:false, test:false };

    function getChartSize(){
      const rect = el.getBoundingClientRect();
      let w = Math.max(rect.width, el.clientWidth, 600);
      let h = Math.max(rect.height, el.clientHeight, 560);
      return { w:Math.floor(w), h:Math.floor(h) };
    }

    function colorFor(node){
      if(!state.harm) return node.color || '#7ea3c9';
      return TRAUMA_COLORS[node.harm] || (node.color || '#7ea3c9');
    }

    function nodeTooltip(d){
      let html = `<strong>${d.name}</strong>`;
      if(d.cost) html += `<br><em>Cost:</em> ${d.cost}`;
      if(d.outcome) html += `<br><em>Outcomes:</em> ${d.outcome}`;
      if(state.faith && d.faith) html += `<br><em>Faith Lens:</em> ${d.faith}`;
      return html;
    }

    function nodePanel(d){
      return `
        <div><strong>${d.name}</strong></div>
        ${d.cost?`<div><em>Cost:</em> ${d.cost}</div>`:''}
        ${d.outcome?`<div><em>Outcomes:</em> ${d.outcome}</div>`:''}
        ${state.faith && d.faith?`<div><em>Faith Lens:</em> ${d.faith}</div>`:''}
        <div class='note' style='margin-top:8px'>Citations coming: hover text will link to sources once local data are loaded.</div>
      `;
    }

    function toGraph(){
      const nodes = nodesBase.map(d=>Object.assign({}, d));
      const linksBase = state.view==='current' ? linksCurrentBase : linksHFBase;
      const links = linksBase.map(({s,t,v})=>({ source:s, target:t, value:v }));
      return { nodes, links };
    }

    function render(){
      if(!(window.d3 && d3.sankey)){
        details.innerHTML = "<div class='note'>Waiting for scripts…</div>";
        return;
      }

      el.innerHTML='';
      const { w, h } = getChartSize();
      debug.textContent = `w:${w} h:${h} | view:${state.view} | test:${state.test}`;

      const width = Math.max(320, w);
      const height = Math.max(260, h);

      const svg = d3.select('#chart').append('svg')
        .attr('width', width)
        .attr('height', height);

      const sankey = d3.sankey()
        .nodeWidth(18)
        .nodePadding(16)
        .extent([[10,10],[width-10,height-10]]);

      if(state.test){
        const testGraph = {
          nodes:[{name:'A',harm:'low',color:'#4CAF50'},{name:'B',harm:'high',color:'#FF4C4C'}],
          links:[{source:0,target:1,value:5}]
        };
        const layout = sankey(testGraph);
        draw(layout.nodes, layout.links, svg);
        details.innerHTML = "<div class='note'>Health check rendered.</div>";
        return;
      }

      const graph = toGraph();
      const layout = sankey(graph);
      draw(layout.nodes, layout.links, svg);
      details.innerHTML = `<div class='note'>Tip: Click a node to pin details here.</div>`;
    }

    function draw(N, L, svg){
      svg.append('g').selectAll('path')
        .data(L)
        .join('path')
          .attr('d', d3.sankeyLinkHorizontal())
          .attr('fill', 'none')
          .attr('stroke', 'rgba(200,220,255,0.35)')
          .attr('stroke-width', d=>Math.max(1, d.width))
          .on('mousemove', (event,d)=>{
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX+12)+'px';
            tooltip.style.top = (event.pageY+12)+'px';
            tooltip.innerHTML = `<strong>Flow</strong><br>${N[d.source.index].name} → ${N[d.target.index].name}<br>People (placeholder): <strong>${d.value}</strong>`;
          })
          .on('mouseleave', ()=>tooltip.style.opacity=0);

      const g = svg.append('g').selectAll('g')
        .data(N)
        .join('g');

      g.append('rect')
        .attr('x', d=>d.x0)
        .attr('y', d=>d.y0)
        .attr('height', d=>Math.max(1, d.y1 - d.y0))
        .attr('width', d=>Math.max(1, d.x1 - d.x0))
        .attr('rx', 6)
        .attr('fill', d=>colorFor(d))
        .attr('stroke', '#0b0c10')
        .on('mousemove', (event,d)=>{
          tooltip.style.opacity = 1;
          tooltip.style.left = (event.pageX+12)+'px';
          tooltip.style.top = (event.pageY+12)+'px';
          tooltip.innerHTML = nodeTooltip(d);
        })
        .on('mouseleave', ()=>tooltip.style.opacity=0)
        .on('click', (_,d)=>{ details.innerHTML = nodePanel(d); });

      const svgWidth = +svg.attr('width');
      g.append('text')
        .attr('x', d=>d.x0 - 6)
        .attr('y', d=> (d.y0 + d.y1)/2 )
        .attr('dy','0.35em')
        .attr('text-anchor','end')
        .attr('fill','#e7edf5')
        .style('font-size','12px')
        .text(d=>d.name)
        .filter(d=>d.x0 < (svgWidth/2))
        .attr('x', d=>d.x1 + 6)
        .attr('text-anchor','start');
    }

    function setPressed(id, pressed){ document.getElementById(id).setAttribute('aria-pressed', pressed?'true':'false'); }

    document.getElementById('view-current').onclick = ()=>{ state.view='current'; state.test=false; setPressed('view-current',true); setPressed('view-hf',false); render(); };
    document.getElementById('view-hf').onclick = ()=>{ state.view='hf'; state.test=false; setPressed('view-hf',true); setPressed('view-current',false); render(); };
    document.getElementById('toggle-harm').onclick = ()=>{ state.harm=!state.harm; render(); };
    document.getElementById('toggle-faith').onclick = ()=>{ state.faith=!state.faith; setPressed('toggle-faith',state.faith); render(); };
    document.getElementById('run-test').onclick = ()=>{ state.test=true; setPressed('run-test',true); render(); };
    document.getElementById('reset').onclick = ()=>{ state.test=false; setPressed('run-test',false); render(); };

    const ro = new ResizeObserver(()=>render());
    ro.observe(document.getElementById('chart'));

    function ready(){ try{ render(); }catch(e){ document.getElementById('debug').textContent = 'Render error: '+(e && e.message ? e.message : e); } }
    if(document.readyState === 'complete' || document.readyState === 'interactive') ready();
    else document.addEventListener('DOMContentLoaded', ready);
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Business of Homelessness — Indiana (Circular)</title>
<style>
  :root{ --bg:#111; --fg:#eee; --muted:#9aa3b2; --green:#4CAF50; --yellow:#FFD700; --red:#FF4C4C; }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  h1{margin:0;padding:20px}
  .lead{color:var(--muted);padding:0 20px 10px}
  .buttons{padding:10px 20px;display:flex;flex-wrap:wrap;gap:8px}
  button{padding:8px 12px;background:#1b1b1b;color:#fff;border:1px solid #3a3a3a;border-radius:999px;cursor:pointer}
  button[aria-pressed="true"]{outline:2px solid #76c7ff}
  button:hover{background:#2a2a2a}
  .row{display:grid;grid-template-columns:1fr;gap:16px;padding:0 20px 20px}
  @media(min-width:900px){.row{grid-template-columns:2.2fr 1fr}}
  .card{background:#161616;border:1px solid #2a2a2a;border-radius:16px;padding:12px}
  #chart{width:100%;height:560px;min-height:360px}
  #tooltip{position:fixed;pointer-events:none;background:#0f1218;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;font-size:13px;line-height:1.35;max-width:320px;color:#e7edf5;z-index:3;opacity:0}
  #debug{background:#222;color:#0f0;font-family:ui-monospace,Monaco,Consolas,monospace;white-space:pre-wrap;padding:10px;border-radius:12px}
  .legend{display:flex;gap:14px;align-items:center;margin-top:8px;color:#cbd5e1;font-size:13px}
  .sw{width:14px;height:14px;border-radius:4px;display:inline-block;margin-right:6px;border:1px solid #111}
  .note{font-size:12px;color:#9aa3b2}
</style>
</head>
<body>
<h1>The Business of Homelessness — Indiana (Prototype)</h1>
<p class="lead">Toggle between the current system and Housing First. Turn on the Faith Lens and Human Harm overlay to see more than dollars. Data below are <strong>placeholders</strong> until local figures are finalized.</p>

<div class="buttons" role="group" aria-label="Dashboard controls">
  <button id="btn-current" aria-pressed="true">Current System</button>
  <button id="btn-hf" aria-pressed="false">Housing First</button>
  <button id="btn-harm" aria-pressed="true">Human Harm Overlay</button>
  <button id="btn-faith" aria-pressed="false">Faith Lens</button>
  <button id="btn-health">Run Health Check</button>
  <button id="btn-reset">Reset Prototype</button>
</div>

<div class="row">
  <div class="card">
    <div id="chart" aria-label="Sankey diagram"></div>
    <div class="legend">
      <span><span class="sw" style="background:#FF4C4C"></span>High trauma</span>
      <span><span class="sw" style="background:#FFD700"></span>Moderate trauma</span>
      <span><span class="sw" style="background:#4CAF50"></span>Low trauma</span>
    </div>
    <p class="note">Hover nodes/links for details. Costs/outcomes are placeholders; citations will be linked once local numbers are finalized.</p>
  </div>
  <aside class="card">
    <h3 style="margin:6px 6px 8px">Details</h3>
    <div id="details" class="note">Loading libraries…</div>
    <h4 style="margin:12px 6px 6px">Debug Output</h4>
    <div id="debug">Bootstrapping…</div>
  </aside>
</div>

<div id="tooltip"></div>

<script>
/* ===== Robust loader + global error capture ===== */
(function(){
  const dbg = () => document.getElementById('debug');
  const log = (m) => { const el = dbg(); if (el) el.textContent += '\n' + m; };

  // Show ANY runtime errors
  window.addEventListener('error', (e) => log('window.error: ' + (e.message || e)));
  window.addEventListener('unhandledrejection', (e) => log('unhandledrejection: ' + (e.reason && e.reason.message || e.reason)));

  function loadScript(src, label, ms=15000){
    return new Promise((resolve, reject) => {
      let done = false;
      const t = setTimeout(() => {
        if (done) return;
        done = true;
        log('Timeout loading: ' + label + ' (' + src + ')');
        reject(new Error('timeout ' + src));
      }, ms);

      const s = document.createElement('script');
      s.src = src; s.async = true; s.defer = false;
      s.onload = () => { if (done) return; done = true; clearTimeout(t); log('Loaded: ' + label); resolve(src); };
      s.onerror = () => { if (done) return; done = true; clearTimeout(t); log('Failed: ' + label + ' (' + src + ')'); reject(new Error('load fail ' + src)); };
      document.head.appendChild(s);
      log('Loading: ' + label + ' (' + src + ')');
    });
  }

  async function ensureLibs(){
    log('ensureLibs: start');

    // 1) D3 core
    try {
      // prefer local if present (index.html); CDN only on index-cdn.html works too
      await loadScript('./lib/d3.v7.min.js', 'd3 (local)', 15000)
        .catch(() => loadScript('https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js', 'd3 (cdn)', 15000));
    } catch(e) {
      log('FATAL: d3 failed: ' + (e.message||e));
      throw e;
    }

    // 2) Standard sankey (fallback base)
    const sankeyTry = [
      ['./lib/d3-sankey.min.js', 'sankey (local)'],
      ['https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js', 'sankey (jsdelivr)'],
      ['https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js', 'sankey (unpkg)'],
    ];
    let sankeyOK = false;
    for (const [src, lbl] of sankeyTry) {
      try { await loadScript(src, lbl, 15000); sankeyOK = true; break; } catch {}
    }
    if (!sankeyOK) log('WARN: standard d3-sankey missing; we can still draw a placeholder.');

    // 3) Circular plugin (optional)
    const circTry = [
      ['./lib/d3-sankey-circular.min.js', 'circular (local)'],
      ['https://cdn.jsdelivr.net/npm/d3-sankey-circular@0.39.1/build/d3-sankey-circular.min.js', 'circular (jsdelivr:min)'],
      ['https://cdn.jsdelivr.net/npm/d3-sankey-circular@0.39.1/build/d3-sankey-circular.js', 'circular (jsdelivr)'],
      ['https://unpkg.com/d3-sankey-circular@0.39.1/build/d3-sankey-circular.min.js', 'circular (unpkg:min)'],
      ['https://unpkg.com/d3-sankey-circular@0.39.1/build/d3-sankey-circular.js', 'circular (unpkg)'],
    ];
    for (const [src, lbl] of circTry) {
      try { await loadScript(src, lbl, 15000); break; } catch {}
    }

    log('ensureLibs: done');
  }

  // expose
  window.__AFH__ = { ensureLibs };
})();
</script>

<script>
/* ===== Boot and always render something ===== */
(async function boot(){
  const debug = document.getElementById('debug');
  const details = document.getElementById('details');
  const log = (m)=> debug.textContent += '\n' + m;

  try {
    await window.__AFH__.ensureLibs();
  } catch (e) {
    log('ensureLibs threw: ' + (e.message||e));
  }

  try {
    // your existing render() call; if it throws, we show a tiny placeholder
    if (typeof render === 'function') {
      render();
      return;
    }
    log('No render() defined?');
  } catch (e) {
    log('render() error: ' + (e.message||e));
  }

  // Minimal placeholder (d3 only) so page isn’t blank
  try {
    const el = document.getElementById('chart');
    el.innerHTML = '';
    const w = Math.max(300, el.clientWidth || 600), h = 200;
    const svg = d3.select('#chart').append('svg').attr('width', w).attr('height', h);
    svg.append('text').attr('x',12).attr('y',24).attr('fill','#ccc').text('Libraries loaded; waiting to draw Sankey…');
    details.textContent = 'Fallback placeholder drawn (no Sankey). See Debug for loader status.';
  } catch (e) {
    log('Fallback draw failed: ' + (e.message||e));
  }
})();
</script>
</body>
</html>
